<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AVATA – Automatic Veteran and Ancient Tree Assessment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      color-scheme: light dark;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(18px);
      background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(15,23,42,0.85));
      border-bottom: 1px solid rgba(148,163,184,0.25);
      padding: 0.5rem 1.1rem;
    }
    #headerInner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }
    #headerLeft {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }
    #appHeaderLogo {
      max-height: 40px;
      max-width: 140px;
      object-fit: contain;
      border-radius: 4px;
      border: 1px solid rgba(148,163,184,0.5);
      display: none;
      background: #020617;
    }
    header h1 {
      margin: 0;
      font-size: 1.05rem;
    }
    header small {
      display: block;
      font-size: 0.7rem;
      color: #cbd5f5;
      opacity: 0.9;
    }
    main {
      max-width: 1040px;
      margin: 0 auto;
      padding: 1.1rem 1rem 2.5rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 2.4fr);
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }
    .card {
      background: rgba(15,23,42,0.96);
      border-radius: 1rem;
      padding: 1rem 1.1rem;
      box-shadow: 0 18px 40px rgba(15,23,42,0.6);
      border: 1px solid rgba(148,163,184,0.3);
      margin-bottom: 1rem;
    }
    .card h2 {
      margin-top: 0;
      font-size: 0.95rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #e5e7eb;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: rgba(56,189,248,0.1);
      color: #38bdf8;
      border: 1px solid rgba(56,189,248,0.35);
    }
    .badge span.dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #38bdf8;
    }
    label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      color: #e5e7eb;
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 0.55rem 0.7rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148,163,184,0.7);
      font-size: 0.85rem;
      outline: none;
      background: rgba(15,23,42,0.9);
      color: #f9fafb;
      caret-color: #e5e7eb;
    }
    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
      background: #020617;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .help {
      font-size: 0.72rem;
      color: #9ca3af;
      margin-top: 0.12rem;
    }
    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.4rem 0.75rem;
    }
    .feature-card {
      border-radius: 0.7rem;
      padding: 0.4rem 0.6rem;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.7);
      transition: border-color 0.15s, background 0.15s, box-shadow 0.15s;
    }
    .feature-card:hover {
      border-color: rgba(56,189,248,0.7);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
    }
    .feature-main {
      display: flex;
      align-items: center;
      gap: 0.45rem;
    }
    .feature-card input[type="checkbox"] {
      accent-color: #38bdf8;
      width: 0.9rem;
      height: 0.9rem;
    }
    .feature-name {
      font-size: 0.82rem;
      font-weight: 500;
      color: #e5e7eb;
    }
    .feature-meta {
      font-size: 0.72rem;
      color: #9ca3af;
      margin-left: 1.4rem;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-weight: 500;
    }
    .btn-primary {
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: #f9fafb;
      box-shadow: 0 8px 18px rgba(21,128,61,0.6);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.5);
    }
    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px dashed rgba(148,163,184,0.7);
    }
    .btn-primary:active,
    .btn-secondary:active,
    .btn-ghost:active {
      transform: translateY(1px);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      font-size: 0.72rem;
      font-weight: 500;
      border: 1px solid transparent;
    }
    .pill-info {
      background: rgba(56,189,248,0.08);
      color: #38bdf8;
      border-color: rgba(56,189,248,0.5);
    }
    .pill-ok {
      background: rgba(34,197,94,0.08);
      color: #4ade80;
      border-color: rgba(34,197,94,0.5);
    }
    .pill-warn {
      background: rgba(250,204,21,0.08);
      color: #facc15;
      border-color: rgba(250,204,21,0.5);
    }
    .pill-alert {
      background: rgba(248,113,113,0.1);
      color: #fca5a5;
      border-color: rgba(248,113,113,0.6);
    }
    .result-block {
      padding: 0.7rem 0.85rem;
      border-radius: 0.9rem;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(148,163,184,0.4);
      margin-top: 0.5rem;
    }
    .result-block h3 {
      margin: 0 0 0.35rem 0;
      font-size: 0.92rem;
      color: #e5e7eb;
    }
    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.6rem 1rem;
      font-size: 0.8rem;
      margin-top: 0.35rem;
    }
    .result-label {
      font-weight: 600;
      color: #9ca3af;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .footer-note {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.6rem;
    }
    .statusbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
      margin-top: 0.25rem;
    }
    .divider {
      border-top: 1px dashed rgba(148,163,184,0.4);
      margin: 0.75rem 0;
    }
    .photos-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.4rem;
    }
    .photo-thumb {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 0.5rem;
      border: 1px solid rgba(148,163,184,0.6);
    }
    #reportText {
      width: 100%;
      box-sizing: border-box;
      margin-top: 0.5rem;
      min-height: 6rem;
      font-size: 0.8rem;
      white-space: pre-wrap;
    }

    /* PDF report preview area (not shown in normal UI) */
    #pdfReport {
      position: absolute;
      left: -99999px;
      top: 0;
      width: 794px; /* A4 width at 96dpi approx */
      background: #ffffff;
      color: #000000;
      padding: 24px 32px;
      box-sizing: border-box;
      font-size: 12px;
    }
    #pdfReport h1 {
      margin-top: 0;
      font-size: 18px;
    }
    #pdfReport h2 {
      font-size: 14px;
      margin-bottom: 4px;
    }
    #pdfReport p, #pdfReport li {
      font-size: 12px;
    }
    #pdfReport-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    #pdfReport-logo {
      max-height: 50px;
      max-width: 150px;
      object-fit: contain;
    }
    #pdfReport img.photo {
      width: auto;
      max-width: 100%;
      max-height: 320px;
      object-fit: contain;
      margin: 4px 0;
      border-radius: 3px;
      border: 1px solid #ccc;
    }
  
@media print {
  /* Hide the interactive UI when printing */
  header,
  .layout > div:first-child,
  .card .btn-row,
  #results,
  #reportText {
    display: none !important;
  }

  body {
    background: #ffffff !important;
    color: #000000 !important;
    margin: 0;
  }

  main {
    max-width: none;
    margin: 0;
    padding: 0;
  }

  #pdfReport {
    position: static !important;
    left: auto !important;
    top: auto !important;
    width: auto !important;
    padding: 15mm 20mm !important;
    background: #ffffff !important;
    color: #000000 !important;
  }
}


/* ===== AVATA banner (Option B classic) ===== */
.avata-banner{
  background: linear-gradient(135deg, #0f172a 0%, #022c22 45%, #14532d 100%);
  color:#f9f5e7;
  border-bottom:1px solid rgba(148,163,184,0.4);
  box-shadow:0 4px 18px rgba(15,23,42,0.35);
}
.avata-banner-inner{
  max-width:1100px;
  margin:0 auto;
  padding:0.75rem 1.25rem;
  display:flex;
  align-items:center;
  gap:0.85rem;
}
.avata-mark{
  width:46px;height:46px;
  border-radius:999px;
  padding:0.35rem;
  border:1px solid rgba(148,163,184,0.45);
  background: radial-gradient(circle at 30% 20%, rgba(248,250,252,0.12), transparent 55%);
  display:flex;align-items:center;justify-content:center;
}
.avata-logo{ width:40px;height:40px; display:block; }
.avata-wording{ display:flex; flex-direction:column; gap:0.15rem; min-width:0; }
.avata-name{
  font-family: Georgia, "Times New Roman", serif;
  font-weight:700;
  letter-spacing:0.18em;
  text-transform:uppercase;
  font-size:1.35rem;
  line-height:1.05;
}
.avata-sub{
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size:0.78rem;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color: rgba(226,232,240,0.92);
}


/* Multi-stem BS5837 helper */
.multi-rows { display:flex; flex-direction:column; gap:8px; }
.stem-row { display:flex; gap:10px; align-items:center; }
.stem-row input[type="number"] { width: 120px; }
.stem-row .stem-label { width: 92px; font-weight:600; color:#0f172a; }
.stem-row .remove-stem { margin-left:auto; }
.panel { border: 1px solid rgba(15,23,42,0.15); border-radius: 12px; padding: 12px; background: rgba(148,163,184,0.15); }

/* TreMs separation */
.section-divider{
  height:1px;
  background: rgba(15,23,42,0.18);
  margin: 18px 0 14px;
}
.subsection-title{
  margin: 0 0 6px;
  font-size: 1.02rem;
  letter-spacing: 0.02em;
}
.subsection-note{
  margin: 0 0 12px;
  color: rgba(15,23,42,0.72);
  font-size: 0.9rem;
}

/* TreMs grouped (collapsible) */
.trem-groups{ display:flex; flex-direction:column; gap:12px; }
.trem-actions{ display:flex; gap:10px; margin: 2px 0 10px; flex-wrap:wrap; }
.trem-group{ border: 1px solid rgba(15,23,42,0.14); border-radius: 14px; background: rgba(255,255,255,0.75); overflow:hidden; box-shadow: 0 1px 0 rgba(15,23,42,0.04); }
.trem-group > summary{ cursor:pointer; user-select:none; padding: 12px 14px; font-weight: 800; color:#ffffff; background: #0f172a; display:flex; gap:10px; align-items:baseline; border-bottom: 1px solid rgba(255,255,255,0.18); }
.trem-group > summary::-webkit-details-marker{ display:none; }
.trem-group > summary::before{ content:'▸'; display:inline-block; transform: translateY(-1px); opacity:0.75; }
.trem-group[open] > summary::before{ content:'▾'; }
.trem-range{ font-weight:600; color: rgba(255,255,255,0.78); font-size:0.9rem; }
.trem-grid{ padding: 12px 12px 14px; }
</style>
  <!-- jsPDF + html2canvas from CDN (requires connectivity when generating PDF) -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b2a4a">
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js');
}
</script>
</head>

<body>

  <header class="avata-banner" role="banner" aria-label="AVATA header">
    <div class="avata-banner-inner">
      <div class="avata-mark" aria-hidden="true">
        <svg viewBox="0 0 96 64" class="avata-logo" aria-hidden="true">
  <defs>
    <linearGradient id="avataOakGrad" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#1f2937"/>
      <stop offset="55%" stop-color="#14532d"/>
      <stop offset="100%" stop-color="#4d7c0f"/>
    </linearGradient>
    <filter id="avataSoft" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="0.6" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>

  <!-- canopy silhouette -->
  <path d="M18 38
           C10 34,10 24,18 22
           C18 14,28 10,35 14
           C40 6,56 6,61 14
           C70 10,80 14,80 22
           C88 24,88 34,80 38
           C82 44,74 50,66 48
           C60 54,50 56,44 52
           C38 58,24 54,28 46
           C22 50,14 44,18 38 Z"
        fill="url(#avataOakGrad)" opacity="0.92" filter="url(#avataSoft)"/>

  <!-- trunk + veteran buttress -->
  <path d="M46 60
           C44 54,44 48,42 42
           C40 36,34 34,34 28
           C34 22,40 22,42 26
           C44 20,52 20,54 26
           C56 22,62 22,62 28
           C62 34,56 36,54 42
           C52 48,52 54,50 60
           Z"
        fill="#5b3a20" opacity="0.95" stroke="rgba(249,245,231,0.55)" stroke-width="1.2" />

  <!-- gnarly branches -->
  <path d="M46 40
           C44 34,38 30,32 28
           M50 40
           C54 34,60 30,66 28
           M44 34
           C40 30,36 26,28 24
           M52 34
           C56 30,60 26,68 24"
        fill="none" stroke="rgba(249,245,231,0.75)" stroke-width="2.2" stroke-linecap="round"/>

  <!-- ground line -->
  <path d="M8 60 H88" stroke="rgba(249,245,231,0.45)" stroke-width="2" stroke-linecap="round"/>
</svg>
      </div>
      <div class="avata-wording">
        <div class="avata-name">AVATA</div>
        <div class="avata-sub">Automatic Veteran and Ancient Tree Assessment</div>
      </div>
    </div>
  </header>

<header>
  <div id="headerInner">
    <div id="headerLeft">
      <img id="appHeaderLogo" alt="Logo" />
      <div>
        <h1>Ancient &amp; Veteran Tree Tool</h1>
        <small>TreMs + RAVEN 2 + ATF girth bands + FCIN12</small>
      </div>
    </div>
  </div>
</header>
<main>
  <div class="layout">
    <div>
      <!-- Tree inputs -->
      <section class="card">
        <h2>
          Tree basics
          <span class="badge"><span class="dot"></span> Inputs</span>
        </h2>

        <div class="row">
          <div>
            <label for="speciesSelect">Species (quick pick)</label>
            <select id="speciesSelect">
              <option value="">Select species…</option>
              <option value="quercus_robur">Oak (Quercus robur)</option>
              <option value="castanea_sativa">Sweet chestnut (Castanea sativa)</option>
              <option value="fagus_sylvatica">Beech (Fagus sylvatica)</option>
              <option value="tilia_sp">Lime (Tilia sp.)</option>
              <option value="fraxinus_excelsior">Ash (Fraxinus excelsior)</option>
              <option value="acer_pseudoplatanus">Sycamore (Acer pseudoplatanus)</option>
              <option value="crack_willow">Crack willow</option>
              <option value="taxus_baccata">Yew (Taxus baccata)</option>
              <option value="pinus_sylvestris">Scots pine (Pinus sylvestris)</option>
              <option value="alnus_glutinosa">Alder (Alnus glutinosa)</option>
              <option value="acer_campestre">Field maple (Acer campestre)</option>
              <option value="carpinus_betulus">Hornbeam (Carpinus betulus)</option>
              <option value="sorbus_aucuparia">Rowan (Sorbus aucuparia)</option>
              <option value="ilex_aquifolium">Holly (Ilex aquifolium)</option>
              <option value="salix_caprea">Sallow / goat willow (Salix caprea)</option>
              <option value="crataegus_monogyna">Hawthorn (Crataegus monogyna)</option>
              <option value="malus_domestica">Apple (Malus domestica)</option>
              <option value="sambucus_nigra">Elder (Sambucus nigra)</option>
              <option value="other">Other / not listed</option>
            </select>
            <div class="help">You can override or type any species name below.</div>
          </div>
          <div>
            <label for="speciesCustom">Species (override)</label>
            <input id="speciesCustom" type="text" placeholder="e.g. veteran field oak" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="dbh">DBH (mm)</label>
            <input id="dbh" type="number" min="0" step="1" placeholder="e.g. 1200" />
            <div class="help">Standard diameter at 1.3 m. The tool converts DBH → girth.</div>
            <div class="subrow" style="margin-top:10px;">
              <label class="inline">
                <input type="checkbox" id="multiStemToggle" />
                Multi‑stem calculation (BS5837 equivalent stem)
              </label>
            </div>
            <div id="multiStemPanel" class="panel" style="display:none; margin-top:10px;">
              <div class="help" style="margin-bottom:10px;">
                Enter stem diameters (mm) measured at the same height (typically 1.3 m). Equivalent stem is calculated automatically.
                For ≤5 stems: √(Σ d²). For ≥6 stems: mean(d) × √n.
              </div>
              <div id="multiStemRows" class="multi-rows"></div>
              <div class="subrow" style="gap:10px; align-items:center;">
                <button type="button" class="btn small" id="addStemBtn">+ Add stem</button>
                <button type="button" class="btn small ghost" id="clearStemsBtn">Clear</button>
                <div style="margin-left:auto; font-weight:700;">
                  Equivalent DBH: <span id="eqDbhText">—</span> mm
                </div>
              </div>
            </div>

          </div>
          <div>
            <label for="dbhHeight">Measurement height (m)</label>
            <input id="dbhHeight" type="number" min="0" step="0.1" value="1.3" />
            <div class="help">ATF &amp; FCIN12 assume 1.3 m. If not, the comparison is approximate.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="girth">Girth (m)</label>
            <input id="girth" type="number" min="0" step="0.01" placeholder="auto from DBH, or enter directly" />
            <div class="help">If you enter DBH, this is auto-filled using girth ≈ π × DBH.</div>
          </div>
          <div>
            <label for="height">Approx. height (m) <span style="font-weight:400;color:#9ca3af">(optional)</span></label>
            <input id="height" type="number" min="0" step="0.1" placeholder="e.g. 18" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="growthCond">Growth conditions</label>
            <select id="growthCond">
              <option value="average">Average / typical</option>
              <option value="good">Good / open-grown</option>
              <option value="poor">Poor / exposed / suppressed</option>
            </select>
            <div class="help">Used by the FCIN12-style age estimate.</div>
          <div class="fcin-extra">
            <h3 class="card-subtitle">FCIN12 age context (optional)</h3>
            <p class="help">
              Record additional FCIN12-style context for growth and history. These do not change the girth-based age directly,
              but they widen or skew the indicative age range and are echoed in the reasoning.
            </p>
            <div class="features-grid">
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="open-grown" />
                  <span class="feature-name">Open-grown / parkland</span>
                </span>
                <span class="feature-meta">Faster girth increment likely</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="woodland" />
                  <span class="feature-name">Woodland-grown / historic competition</span>
                </span>
                <span class="feature-meta">Slightly slower girth increment</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="long-suppressed" />
                  <span class="feature-name">Long-term suppressed</span>
                </span>
                <span class="feature-meta">Age may be higher than girth suggests</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="suppressed-then-released" />
                  <span class="feature-name">Suppressed then released</span>
                </span>
                <span class="feature-meta">Release growth phase may inflate girth for age</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="pollard" />
                  <span class="feature-name">Historic pollard / lapsed pollard</span>
                </span>
                <span class="feature-meta">Framework tree may pre-date current stem size</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="poor-rooting" />
                  <span class="feature-name">Poor rooting volume / restrictions</span>
                </span>
                <span class="feature-meta">Reduced girth increment expected</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="exposed-coastal" />
                  <span class="feature-name">Exposed / upland / coastal</span>
                </span>
                <span class="feature-meta">Growth likely slowed at times</span>
              </label>
              <label class="feature-card">
                <span class="feature-main">
                  <input type="checkbox" class="fcin-flag" data-effect="fertile-sheltered" />
                  <span class="feature-name">Fertile / sheltered site</span>
                </span>
                <span class="feature-meta">Faster girth increment expected</span>
              </label>
            </div>
          </div>

          </div>
          <div>
            <label for="siteContext">Site context <span style="font-weight:400;color:#9ca3af">(optional)</span></label>
            <textarea id="siteContext" placeholder="e.g. hedgerow tree on farmland, adjacent to public footpath…"></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="logoInput">Logo (for app &amp; PDF)</label>
            <input id="logoInput" type="file" accept="image/*" />
            <div class="help">Add your practice logo. It shows in the header and in the generated PDF.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="surveyorName">Surveyor</label>
            <div style="display:flex;flex-wrap:wrap;gap:0.4rem;align-items:center;">
              <select id="surveyorNameList" style="flex:0 0 180px;max-width:50%;">
                <option value="">Select saved name…</option>
              </select>
              <input id="surveyorName" type="text" placeholder="Type surveyor name…" style="flex:1 1 140px;min-width:140px;" />
              <button type="button" id="btnSaveSurveyor">Save name</button>
            </div>
            <div class="help">Choose a saved surveyor or type a new one. Saved names are stored in this browser only.</div>
          </div>
        </div>
      </section>

      <!-- Risk & photos -->
      <section class="card">
        <h2>
          Risk &amp; photos
          <span class="badge"><span class="dot"></span> Optional</span>
        </h2>

        <div class="row">
          <div>
            <label for="targetZone">Target use</label>
            <select id="targetZone">
              <option value="none">None / very low</option>
              <option value="occasional">Occasional use</option>
              <option value="regular">Regular use</option>
              <option value="constant">Constant high use</option>
            </select>
            <div class="help">For risk context only – not part of RAVEN score.</div>
          </div>
          <div>
            <label for="notes">Inspector notes <span style="font-weight:400;color:#9ca3af">(optional)</span></label>
            <textarea id="notes" placeholder="Structural notes, defects, ecology, bat potential, etc."></textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="photoInput">Photos (stay on device)</label>
            <input id="photoInput" type="file" accept="image/*" multiple />
            <div class="help">Select images from your phone/tablet. They are not uploaded. For best PDF layout, use mainly portrait-orientation photos; landscape shots may be shrunk or appear smaller.</div>
          </div>
        </div>
        <div id="photoList" class="photos-grid"></div>
      </section>
    </div>

    <div>
      <!-- TreMs / RAVEN features -->
      <section class="card">
        <h2>
          RAVEN2 structural features
          <span class="badge"><span class="dot"></span> Features</span>
        </h2>
        <p class="help">
          Checklist taken from your <em>TreMs_RAVEN_Veteran_Assessment.xlsx</em>. Tick each microhabitat present on the tree. Rarity and feature type feed into the scoring.
        </p>

        
        <h3 class="card-subtitle">RAVEN2 primary &amp; secondary features (White Method)</h3>
        
        <div class="features-grid" id="ravenFeatures">
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="primary" data-weight="2" data-name="Heartwood decay / hollowing" />
              <span class="feature-name">Heartwood decay / hollowing</span>
            </span>
            <span class="feature-meta">Primary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="primary" data-weight="2" data-name="Major trunk cavity / through-stem hollow" />
              <span class="feature-name">Major trunk cavity / through-stem hollow</span>
            </span>
            <span class="feature-meta">Primary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="primary" data-weight="1" data-name="Retrenchment / strong crown dieback" />
              <span class="feature-name">Retrenchment / strong crown dieback</span>
            </span>
            <span class="feature-meta">Primary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="primary" data-weight="1" data-name="Large old pruning wounds / pollard heads" />
              <span class="feature-name">Large old pruning wounds / pollard heads</span>
            </span>
            <span class="feature-meta">Primary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="secondary" data-weight="1" data-name="Extensive deadwood in crown" />
              <span class="feature-name">Extensive deadwood in crown</span>
            </span>
            <span class="feature-meta">Secondary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="secondary" data-weight="1" data-name="Major decay columns on stem / scaffold branches" />
              <span class="feature-name">Major decay columns on stem / scaffold branches</span>
            </span>
            <span class="feature-meta">Secondary veteran feature</span>
          </label>
          <label class="feature-card">
            <span class="feature-main">
              <input type="checkbox" class="raven-feature" data-type="secondary" data-weight="1" data-name="Strong epiphyte / bryophyte / lichen development" />
              <span class="feature-name">Strong epiphyte / bryophyte / lichen development</span>
            </span>
            <span class="feature-meta">Secondary veteran feature</span>
          </label>
        </div>

<div class="section-divider"></div>
<h3 class="subsection-title">Tree-related microhabitats (TreMs)</h3>
<div class="subsection-note">Counts (0–10) with rarity weighting. TreMs are grouped for quicker field use and reported as an ecological signal alongside RAVEN2.</div>
<div id="microhabitats" class="trem-groups">
  <div class="trem-actions">
    <button type="button" class="btn small ghost" id="btnTremsExpand">Expand all</button>
    <button type="button" class="btn small ghost" id="btnTremsCollapse">Collapse all</button>
  </div>
  <details class="trem-group" open>
    <summary>Cavities & hollows <span class="trem-range">(1–15)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="0" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">1. Small woodpecker breeding cavity</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="1" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">2. Medium-sized woodpecker breeding cavity</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="2" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">3. Large woodpecker breeding cavity</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="3" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">4. Woodpecker flute</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="4" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">5. Trunk-base rot-hole (ground contact)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="5" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">6. Trunk rot-hole (no ground contact)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="6" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">7. Semi-open trunk rot-hole</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="7" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">8. Chimney trunk-base rot-hole (ground contact)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="8" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">9. Chimney trunk rot-hole (no ground contact)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="9" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">10. Hollow branch</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="10" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">11. Insect galleries and bore holes</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="11" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">12. Dendrotelm</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="12" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">13. Large woodpecker foraging excavation</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="13" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">14. Bark-lined trunk concavity</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="14" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">15. Buttress-root concavity</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Exposed wood, bark structures & damage <span class="trem-range">(16–25)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="15" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">16. Bark loss</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="16" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">17. Fire scar</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="17" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">18. Bark shelter</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="18" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">19. Bark pocket</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="19" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">20. Stem breakage</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="20" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">21. Limb breakage</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="21" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">22. Crack</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="22" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">23. Lightning scar</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="23" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">24. Fork split at the intersection</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="24" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">25. Trunk gnawed by beavers</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Deadwood & breakage <span class="trem-range">(26–28)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="25" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">26. Dead branches</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="26" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">27. Dead top</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="27" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">28. Remnants of a broken limb</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Deformities & growth forms <span class="trem-range">(29–33)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="28" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">29. Witches&#x27; broom</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="29" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">30. Epicormic shoots</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="30" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">31. Galls</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="31" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">32. Burr (burl)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="32" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">33. Canker</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Fungi & slime moulds <span class="trem-range">(34–39)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="33" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">34. Perennial polypore</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="34" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">35. Annual polypore</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="35" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">36. Pulpy agaric</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="36" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">37. Corticoid fungi (crust fungi)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="37" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">38. Large pyrenomycetoid fungi (stromatic sordariomycetes)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="38" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">39. Myxogastria (myxomycetes / plasmodial slime moulds)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Epiphytes & plants <span class="trem-range">(40–44)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="39" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">40. Bryophytes (mosses and liverworts)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="40" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">41. Foliose and fruticose lichens</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="41" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">42. Ivy and lianas (woody vines)</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="42" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">43. Ferns</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="43" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">44. Mistletoe</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Nests <span class="trem-range">(45–46)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="44" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">45. Vertebrate nest</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="45" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">46. Invertebrate nest</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Microsoils & deposits <span class="trem-range">(47–50)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="46" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">47. Bark microsoil</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="47" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">48. Inter-bark microsoil</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="48" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">49. Crown microsoil</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="49" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">50. Clay or silt deposit</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
  <details class="trem-group">
    <summary>Exudates <span class="trem-range">(51–52)</span></summary>
    <div class="features-grid trem-grid">
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="50" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">51. Sap run</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
<label class="feature-card">
        <span class="feature-main">
          <input type="number" class="microhabitat" data-index="51" data-type="Secondary" data-raven-feature="TreM (WSL 2024)" data-score="1" data-rarity="1" min="0" max="10" value="0" />
          <span class="feature-name">52. Heavy resinosis</span>
        </span>
        <span class="feature-meta">TreM (WSL 2024) · count 0–10</span>
      </label>
    </div>
  </details>
</div></div>
      </section>

      <!-- Assessment & report -->
      <section class="card">
        <h2>
          Classification &amp; report
          <span class="badge"><span class="dot"></span> Output</span>
        </h2>

        <div class="btn-row">
          <button class="btn-primary" id="btnAssess">Run assessment</button>
          <button class="btn-secondary" id="btnClear">Reset</button>
          <button class="btn-secondary" id="btnDownloadPng">Download PNG snapshot</button>
        </div>

        <div id="results" style="margin-top:0.75rem;"></div>

        <div class="divider"></div>
        <div class="result-label">Report text (paste into your report)</div>
        <div class="btn-row" style="margin-top:0.35rem;">
          <button class="btn-secondary" id="btnCopyReport">Copy report text</button>
        </div>
        <textarea id="reportText" readonly placeholder="Run an assessment to populate this text."></textarea>

        <p class="footer-note">
          This tool combines TreMs / RAVEN 2 features, ATF mature/ancient girth bands (via DBH → girth), and a simple FCIN12-style age estimate.
          ATF size band and the combined category are shown side by side, and any differences are flagged.
        </p>
      </section>
    </div>
  </div>
</main>

<!-- Hidden PDF report template -->
<div id="pdfReport"></div>

<div id="pngSnapshot" style="position:absolute; left:-99999px; top:0;"></div>

<script>
  // FCIN12-style age configuration (edit to match your spreadsheet if needed)
  const FCIN12_GROWTH_CM_PER_YEAR = {
    quercus_robur: { good: 2.0, average: 1.6, poor: 1.3 },
    fagus_sylvatica: { good: 2.2, average: 1.9, poor: 1.5 },
    fraxinus_excelsior: { good: 2.4, average: 2.1, poor: 1.7 },
    acer_pseudoplatanus: { good: 2.3, average: 2.0, poor: 1.6 },
    default: { good: 2.0, average: 1.8, poor: 1.5 }
  };

  const SPECIES_CONFIG = {
    quercus_robur: { label: "Oak (Quercus robur)" },
    castanea_sativa: { label: "Sweet chestnut (Castanea sativa)" },
    fagus_sylvatica: { label: "Beech (Fagus sylvatica)" },
    tilia_sp: { label: "Lime (Tilia sp.)" },
    fraxinus_excelsior: { label: "Ash (Fraxinus excelsior)" },
    acer_pseudoplatanus: { label: "Sycamore (Acer pseudoplatanus)" },
    crack_willow: { label: "Crack willow" },
    taxus_baccata: { label: "Yew (Taxus baccata)" },
    pinus_sylvestris: { label: "Scots pine (Pinus sylvestris)" },
    alnus_glutinosa: { label: "Alder (Alnus glutinosa)" },
    acer_campestre: { label: "Field maple (Acer campestre)" },
    carpinus_betulus: { label: "Hornbeam (Carpinus betulus)" },
    sorbus_aucuparia: { label: "Rowan (Sorbus aucuparia)" },
    ilex_aquifolium: { label: "Holly (Ilex aquifolium)" },
    salix_caprea: { label: "Sallow / goat willow (Salix caprea)" },
    crataegus_monogyna: { label: "Hawthorn (Crataegus monogyna)" },
    malus_domestica: { label: "Apple (Malus domestica)" },
    sambucus_nigra: { label: "Elder (Sambucus nigra)" },
    default: { label: "Unspecified species" }
  };

  const ATF_GIRTH_THRESHOLDS = {
    castanea_sativa: { mature: 2.0,  ancient: 6.0 },
    quercus_robur:   { mature: 2.25, ancient: 5.75 },
    tilia_sp:        { mature: 2.25, ancient: 5.75 },
    acer_pseudoplatanus: { mature: 2.5,  ancient: 5.75 },
    fagus_sylvatica: { mature: 1.75, ancient: 4.5 },
    crack_willow:    { mature: 1.75, ancient: 4.5 },
    fraxinus_excelsior: { mature: 1.75, ancient: 4.0 },
    taxus_baccata:   { mature: 1.5,  ancient: 4.0 },
    pinus_sylvestris:{ mature: 1.0,  ancient: 3.0 },
    alnus_glutinosa: { mature: 1.0,  ancient: 2.5 },
    acer_campestre:  { mature: 1.0,  ancient: 2.5 },
    carpinus_betulus:{ mature: 1.0,  ancient: 2.5 },
    sorbus_aucuparia:{ mature: 1.0,  ancient: 2.25 },
    ilex_aquifolium: { mature: 1.0,  ancient: 2.0 },
    salix_caprea:    { mature: 1.0,  ancient: 2.0 },
    crataegus_monogyna: { mature: 0.75, ancient: 1.5 },
    malus_domestica: { mature: 0.5,  ancient: 1.25 },
    sambucus_nigra:  { mature: 0.25, ancient: 1.0 },
    default:         { mature: 1.0,  ancient: 3.0 }
  };

  const RAVEN_THRESHOLDS = {
    minFeaturesForVeteran: 2,
    minFeaturesForAncient: 3,
    minPrimaryScoreForVeteran: 3,
    minTotalScoreForVeteran: 6,
    minRareCountForVeteran: 1
  };

  function estimateAgeFromFCIN12(girthMeters, speciesKey, cond) {
    if (!girthMeters || girthMeters <= 0) return null;
    const girthCm = girthMeters * 100;
    const speciesRates = FCIN12_GROWTH_CM_PER_YEAR[speciesKey] || FCIN12_GROWTH_CM_PER_YEAR.default;
    const rate = speciesRates[cond] || speciesRates.average;
    const raw = girthCm / rate;
    return Math.round(raw);
  }
  function evaluateFCIN12(age, speciesKey, girthMeters, growthCond) {
    const reasons = [];
    if (!age || isNaN(age)) {
      reasons.push("FCIN12-style age not estimated; insufficient data.");
      return { ageBand: "unknown", ageLow: null, ageHigh: null, reasons };
    }

    let ageBand = "unknown";
    if (age < 80) {
      ageBand = "young / early mature";
    } else if (age < 150) {
      ageBand = "mid-mature";
    } else if (age < 250) {
      ageBand = "late-mature / veteran-aged";
    } else {
      ageBand = "ancient-aged";
    }

    // baseline uncertainty band: ±20%% around central
    let lowFactor = 0.8;
    let highFactor = 1.2;

    const flags = Array.from(document.querySelectorAll(".fcin-flag")).filter(f => f.checked).map(f => f.dataset.effect || "");

    if (flags.includes("open-grown")) {
      reasons.push("FCIN12 context: open-grown / parkland form noted; girth may have accrued relatively quickly.");
      lowFactor = 0.7;
      highFactor = 1.15;
    }
    if (flags.includes("woodland")) {
      reasons.push("FCIN12 context: woodland-grown / historic competition; girth may under-represent age slightly.");
      lowFactor = Math.min(lowFactor, 0.8);
      highFactor = Math.max(highFactor, 1.25);
    }
    if (flags.includes("long-suppressed")) {
      reasons.push("FCIN12 context: long-term suppression indicated; tree may be materially older than girth alone suggests.");
      lowFactor = Math.min(lowFactor, 0.75);
      highFactor = Math.max(highFactor, 1.35);
    }
    if (flags.includes("suppressed-then-released")) {
      reasons.push("FCIN12 context: suppressed then released; girth may exaggerate age because of a faster release phase.");
      lowFactor = Math.min(lowFactor, 0.7);
      highFactor = Math.max(highFactor, 1.3);
    }
    if (flags.includes("pollard")) {
      reasons.push("FCIN12 context: historic pollard / lapsed pollard; stem size alone may under-represent the age of the framework tree.");
      lowFactor = Math.min(lowFactor, 0.8);
      highFactor = Math.max(highFactor, 1.35);
    }
    if (flags.includes("poor-rooting")) {
      reasons.push("FCIN12 context: rooting volume restrictions; reduced girth increment expected, so age may be toward the upper end of the range.");
      highFactor = Math.max(highFactor, 1.3);
    }
    if (flags.includes("exposed-coastal")) {
      reasons.push("FCIN12 context: exposed / upland / coastal site; growth likely to have been slower at times, adding uncertainty to age estimation.");
      highFactor = Math.max(highFactor, 1.3);
    }
    if (flags.includes("fertile-sheltered")) {
      reasons.push("FCIN12 context: fertile / sheltered site; faster girth increment expected, so true age may be toward the lower end of the range.");
      lowFactor = Math.min(lowFactor, 0.7);
    }

    const ageLow = Math.max(10, Math.round(age * lowFactor));
    const ageHigh = Math.round(age * highFactor);

    reasons.push(`FCIN12-style central age estimate ~${age} years (from girth, species and growth conditions).`);
    reasons.push(`FCIN12-style agedness band: ${ageBand}.`);
    reasons.push(`Indicative FCIN12 age range ~${ageLow}–${ageHigh} years (approximate, diagnostic use only).`);

    return { ageBand, ageLow, ageHigh, reasons };
  }




  function getAtfBand(speciesKey, girthMeters) {
    if (!girthMeters || girthMeters <= 0) return "unknown";
    const thr = ATF_GIRTH_THRESHOLDS[speciesKey] || ATF_GIRTH_THRESHOLDS.default;
    if (girthMeters >= thr.ancient) return "ancient";
    if (girthMeters >= thr.mature) return "mature";
    return "young";
  }

  function summariseFeatures() {
    const boxes = document.querySelectorAll(".microhabitat");
    let totalCount = 0;
    let primaryCount = 0;
    let secondaryCount = 0;
    let primaryScore = 0;
    let secondaryScore = 0;
    let rareCount = 0;
    let rarityBuckets = { 1: 0, 2: 0, 3: 0 };
    const featureNames = new Set();

    boxes.forEach(input => {
      const count = parseInt(input.value || "0", 10);
      if (!count || count <= 0) return;

      totalCount += count;
      const type = (input.dataset.type || "").toLowerCase();
      const score = parseInt(input.dataset.score || "0", 10);
      const rarity = parseInt(input.dataset.rarity || "0", 10);
      const name = input.dataset.ravenFeature || "";
      if (name) featureNames.add(name);
      if (type === "primary") {
        primaryCount += count;
        primaryScore += score * count;
      } else {
        secondaryCount += count;
        secondaryScore += score * count;
      }
      if (rarity && rarityBuckets.hasOwnProperty(rarity)) {
        rarityBuckets[rarity] += count;
        if (rarity === 3) rareCount += count;
      }
    });

    return {
      totalCount,
      primaryCount,
      secondaryCount,
      primaryScore,
      secondaryScore,
      rareCount,
      rarityBuckets,
      uniqueFeatureNames: Array.from(featureNames)
    };
  }
  function summariseRavenFeatures() {
    const inputs = document.querySelectorAll(".raven-feature");
    let primaryCount = 0;
    let secondaryCount = 0;
    let primaryScore = 0;
    let secondaryScore = 0;

    inputs.forEach(input => {
      if (!input.checked) return;
      const type = (input.dataset.type || "").toLowerCase();
      const weight = parseInt(input.dataset.weight || "1", 10);
      if (type === "primary") {
        primaryCount++;
        primaryScore += weight;
      } else {
        secondaryCount++;
        secondaryScore += weight;
      }
    });

    return {
      primaryCount,
      secondaryCount,
      primaryScore,
      secondaryScore
    };
  }

  function evaluateRaven2(age, ravenFeatures, fcin) {
    let ageBand = "unknown";

    if (fcin && fcin.ageBand && fcin.ageBand !== "unknown") {
      ageBand = fcin.ageBand;
    } else if (typeof age === "number" && !isNaN(age)) {
      if (age < 80) {
        ageBand = "young / early mature";
      } else if (age < 150) {
        ageBand = "mid-mature";
      } else if (age < 250) {
        ageBand = "late-mature / veteran-aged";
      } else {
        ageBand = "ancient-aged";
      }
    }

    const { primaryCount, secondaryCount, primaryScore, secondaryScore } = ravenFeatures;
    const totalFeat = primaryCount + secondaryCount;

    let classification = "Outside veteran / notable (RAVEN2-style)";
    const reasons = [];

    if (ageBand !== "unknown") {
      reasons.push(`RAVEN2 / White Method agedness context: ${ageBand}.`);
    } else {
      reasons.push("RAVEN2 / White Method agedness band unknown (age not estimated).");
    }

    if (totalFeat > 0) {
      reasons.push(
        `Recorded RAVEN2 veteran features: ${totalFeat} (primary ${primaryCount}, secondary ${secondaryCount}; approx scores primary ${primaryScore}, secondary ${secondaryScore}).`
      );
    } else {
      reasons.push("No explicit RAVEN2 veteran features ticked in the White Method panel.");
    }

    if (ageBand === "ancient-aged" && primaryCount >= 2 && primaryScore >= 3) {
      classification = "Ancient (candidate, RAVEN2-style)";
    } else if ((ageBand === "ancient-aged" || ageBand === "late-mature / veteran-aged") && totalFeat >= 2) {
      classification = "Veteran (candidate, RAVEN2-style)";
    } else if (totalFeat >= 1 && (ageBand === "mid-mature" || ageBand === "late-mature / veteran-aged")) {
      classification = "Notable (candidate, RAVEN2-style)";
    }

    reasons.unshift(
      `According to a RAVEN2-style interpretation (White Method, using FCIN12-agedness and the recorded primary/secondary veteran features), this tree is ${classification}.`
    );

    return {
      classification,
      ageBand,
      reasons,
      primaryCount,
      secondaryCount,
      primaryScore,
      secondaryScore
    };
  }




  function classifyRAVEN(age, speciesKey, girthMeters, featureSummary, measHeight) {
    const atfBand = getAtfBand(speciesKey, girthMeters);
    const inAncientBand = atfBand === "ancient";
    const inMatureOrAncient = atfBand === "mature" || atfBand === "ancient";

    const {
      totalCount,
      primaryCount,
      secondaryCount,
      primaryScore,
      secondaryScore,
      rareCount,
      rarityBuckets,
      uniqueFeatureNames
    } = featureSummary;

    let classification = "Outside veteran / notable (by this simple scheme)";
    const reasons = [];

    if (girthMeters) {
      reasons.push(`Girth at ${measHeight.toFixed(2)} m ≈ ${girthMeters.toFixed(2)} m; ATF band: ${atfBand} (mature/ancient thresholds).`);
    }
    if (measHeight !== 1.3) {
      reasons.push(`DBH/girth measured at ${measHeight.toFixed(2)} m, not 1.3 m – FCIN12 and ATF comparisons approximate.`);
    }

    if (totalCount > 0) {
      reasons.push(
        `TreMs checklist: ${totalCount} microhabitats ticked (${primaryCount} primary / ${secondaryCount} secondary); primary score ${primaryScore}, secondary score ${secondaryScore}.`
      );
      const rareTextParts = [];
      if (rarityBuckets[3]) rareTextParts.push(`${rarityBuckets[3]} rare (3)`);
      if (rarityBuckets[2]) rareTextParts.push(`${rarityBuckets[2]} uncommon (2)`);
      if (rarityBuckets[1]) rareTextParts.push(`${rarityBuckets[1]} frequent (1)`);
      if (rareTextParts.length) reasons.push("Rarity mix: " + rareTextParts.join(", ") + ".");
    } else {
      reasons.push("No microhabitats ticked in the TreMs checklist.");
    }

    if (uniqueFeatureNames.length) {
      reasons.push("RAVEN feature themes: " + uniqueFeatureNames.join("; ") + ".");
    }

    const strongTreMs =
      primaryScore >= RAVEN_THRESHOLDS.minPrimaryScoreForVeteran &&
      (primaryScore + secondaryScore) >= RAVEN_THRESHOLDS.minTotalScoreForVeteran;

    if (
      inAncientBand &&
      strongTreMs &&
      totalCount >= RAVEN_THRESHOLDS.minFeaturesForAncient &&
      rareCount >= RAVEN_THRESHOLDS.minRareCountForVeteran
    ) {
      classification = "Ancient (candidate)";
    } else if (
      inMatureOrAncient &&
      strongTreMs &&
      totalCount >= RAVEN_THRESHOLDS.minFeaturesForVeteran
    ) {
      classification = "Veteran (candidate)";
    } else if (inMatureOrAncient || totalCount > 0) {
      classification = "Notable (candidate)";
    }

    return {
      classification,
      reasons,
      atfBand,
      inAncientBand
    };
  }

  function targetBadge(targetZone) {
    switch (targetZone) {
      case "none":
        return { text: "Very low target use", cls: "pill-ok" };
      case "occasional":
        return { text: "Occasional target use", cls: "pill-info" };
      case "regular":
        return { text: "Regular target use", cls: "pill-warn" };
      case "constant":
        return { text: "Constant high target use", cls: "pill-alert" };
      default:
        return null;
    }
  }

  const speciesSelect = document.getElementById("speciesSelect");
  const speciesCustom = document.getElementById("speciesCustom");
  const dbhInput = document.getElementById("dbh");
  const dbhHeightInput = document.getElementById("dbhHeight");
  const girthInput = document.getElementById("girth");
  const heightInput = document.getElementById("height");
  const growthCondSelect = document.getElementById("growthCond");
  const siteContext = document.getElementById("siteContext");
  const targetZone = document.getElementById("targetZone");
  const notes = document.getElementById("notes");
  const logoInput = document.getElementById("logoInput");
  const appHeaderLogo = document.getElementById("appHeaderLogo");
  const photoInput = document.getElementById("photoInput");
  const photoListDiv = document.getElementById("photoList");

  // Multi-stem (BS5837 equivalent stem) controls
  const multiStemToggle = document.getElementById("multiStemToggle");
  const multiStemPanel = document.getElementById("multiStemPanel");
  const multiStemRows = document.getElementById("multiStemRows");
  const addStemBtn = document.getElementById("addStemBtn");
  const clearStemsBtn = document.getElementById("clearStemsBtn");
  const eqDbhText = document.getElementById("eqDbhText");
  let dbhManualCache = "";

  function bs5837EquivalentDbh(diams) {
    const ds = diams.map(d => Number(d)).filter(d => Number.isFinite(d) && d > 0);
    const n = ds.length;
    if (n === 0) return null;
    if (n <= 5) {
      const sumsq = ds.reduce((acc, d) => acc + d*d, 0);
      return Math.round(Math.sqrt(sumsq));
    }
    const mean = ds.reduce((a,b)=>a+b,0) / n;
    return Math.round(mean * Math.sqrt(n));
  }

  function buildStemRow(i, value=0) {
    const row = document.createElement("div");
    row.className = "stem-row";
    row.innerHTML = `
      <div class="stem-label">Stem ${i+1}</div>
      <input type="number" class="stem-diam" min="0" step="1" value="${value}" placeholder="DBH (mm)" />
      <button type="button" class="btn small ghost remove-stem">Remove</button>
    `;
    row.querySelector(".remove-stem").addEventListener("click", () => {
      row.remove();
      renumberStemLabels();
      updateEquivalentDbh();
    });
    row.querySelector(".stem-diam").addEventListener("input", updateEquivalentDbh);
    return row;
  }

  function renumberStemLabels() {
    const rows = [...multiStemRows.querySelectorAll(".stem-row")];
    rows.forEach((r, idx) => {
      const lab = r.querySelector(".stem-label");
      if (lab) lab.textContent = `S${idx+1}`;
    });
  }

  function getStemDiams() {
    return [...multiStemRows.querySelectorAll(".stem-diam")].map(inp => inp.value);
  }

  function updateEquivalentDbh() {
    const eq = bs5837EquivalentDbh(getStemDiams());
    eqDbhText.textContent = eq ? String(eq) : "—";
    if (multiStemToggle && multiStemToggle.checked) {
      dbhInput.value = eq ? String(eq) : "";
      dbhInput.dispatchEvent(new Event("input"));
    }
  }

  function ensureMinStemRows() {
    if (!multiStemRows) return;
    if (multiStemRows.querySelectorAll(".stem-row").length === 0) {
      multiStemRows.appendChild(buildStemRow(0));
      multiStemRows.appendChild(buildStemRow(1));
    }
    updateEquivalentDbh();
  }

  if (multiStemToggle) {
    multiStemToggle.addEventListener("change", () => {
      if (multiStemToggle.checked) {
        dbhManualCache = dbhInput.value;
        dbhInput.setAttribute("readonly", "readonly");
        multiStemPanel.style.display = "";
        ensureMinStemRows();
      } else {
        dbhInput.removeAttribute("readonly");
        multiStemPanel.style.display = "none";
        eqDbhText.textContent = "—";
        dbhInput.value = dbhManualCache || "";
        dbhInput.dispatchEvent(new Event("input"));
      }
    });
  }

  if (addStemBtn) {
    addStemBtn.addEventListener("click", () => {
      const count = multiStemRows.querySelectorAll(".stem-row").length;
      if (count >= 10) {
        alert("Up to 10 stems supported.");
        return;
      }
      multiStemRows.appendChild(buildStemRow(count));
      updateEquivalentDbh();
    });
  }

  if (clearStemsBtn) {
    clearStemsBtn.addEventListener("click", () => {
      multiStemRows.innerHTML = "";
      ensureMinStemRows();
    });
  }
  const resultsDiv = document.getElementById("results");
  const reportTextArea = document.getElementById("reportText");
  const btnAssess = document.getElementById("btnAssess");
  const btnClear = document.getElementById("btnClear");
  const btnCopyReport = document.getElementById("btnCopyReport");
  
  const pdfReport = document.getElementById("pdfReport");
  const pngSnapshot = document.getElementById("pngSnapshot");
  const btnDownloadPng = document.getElementById("btnDownloadPng");

  const surveyorNameInput = document.getElementById("surveyorName");
  const surveyorNameSelect = document.getElementById("surveyorNameList");
  const btnSaveSurveyor = document.getElementById("btnSaveSurveyor");

  function loadSurveyorNames() {
    try {
      const raw = window.localStorage ? localStorage.getItem("avt_surveyor_names") : null;
      const names = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(names)) return;
      surveyorNameSelect.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Select saved name…";
      surveyorNameSelect.appendChild(opt);
      names.forEach(name => {
        const o = document.createElement("option");
        o.value = name;
        o.textContent = name;
        surveyorNameSelect.appendChild(o);
      });
    } catch (e) {
      console.warn("Could not load surveyor names from storage", e);
    }
  }

  function saveSurveyorName(name) {
    if (!name) return;
    try {
      const raw = window.localStorage ? localStorage.getItem("avt_surveyor_names") : null;
      let names = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(names)) names = [];
      if (!names.includes(name)) {
        names.push(name);
        names.sort((a, b) => a.localeCompare(b));
        localStorage.setItem("avt_surveyor_names", JSON.stringify(names));
      }
      loadSurveyorNames();
      surveyorNameSelect.value = name;
    } catch (e) {
      console.warn("Could not save surveyor name to storage", e);
    }
  }

  if (surveyorNameSelect && surveyorNameInput) {
    loadSurveyorNames();
    surveyorNameSelect.addEventListener("change", () => {
      const v = surveyorNameSelect.value;
      if (v) surveyorNameInput.value = v;
    });
  }

  if (btnSaveSurveyor && surveyorNameInput) {
    btnSaveSurveyor.addEventListener("click", () => {
      const name = surveyorNameInput.value.trim();
      if (!name) {
        alert("Enter a surveyor name to save.");
        return;
      }
      saveSurveyorName(name);
    });
  }

  let currentPhotoNames = [];
  let currentPhotoData = [];
  let logoDataUrl = null;

  logoInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    logoDataUrl = null;
    appHeaderLogo.style.display = "none";
    appHeaderLogo.src = "";
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      logoDataUrl = ev.target.result;
      appHeaderLogo.src = logoDataUrl;
      appHeaderLogo.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  photoInput.addEventListener("change", (e) => {
    const files = Array.from(e.target.files || []);
    currentPhotoNames = files.map(f => f.name);
    currentPhotoData = [];
    photoListDiv.innerHTML = "";
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = ev.target.result;
        currentPhotoData.push({ name: file.name, dataUrl });
        const img = document.createElement("img");
        img.src = dataUrl;
        img.className = "photo-thumb";
        img.alt = file.name;
        photoListDiv.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  });

  function buildReportText(params) {
    const {
      speciesLabel,
      dbhMm,
      measHeight,
      girthVal,
      heightVal,
      growthCond,
      estAge,
      raven,
      featureSummary,
      ctxText,
      notesText,
      targetZoneVal
    } = params;

    const lines = [];
    lines.push("Tree assessment summary");
    lines.push("----------------------");
    lines.push(`Species: ${speciesLabel}`);
    if (dbhMm) lines.push(`DBH: ${dbhMm.toFixed(0)} mm @ ${measHeight.toFixed(2)} m`);
    lines.push(`Girth: ${girthVal.toFixed(2)} m @ ${measHeight.toFixed(2)} m`);
    if (heightVal) lines.push(`Approx. height: ${heightVal.toFixed(1)} m`);
    lines.push(`Growth conditions (FCIN12 input): ${growthCond}`);
    if (raven.fcin && raven.fcin.ageBand) {
      lines.push(`FCIN12-style agedness band: ${raven.fcin.ageBand}`);
    }
    if (raven.raven2 && raven.raven2.classification) {
      lines.push(`RAVEN2-style interpretation (White Method): ${raven.raven2.classification}`);
    }
    lines.push(`ATF size band (girth only): ${raven.atfBand}`);
    lines.push(`Overall category (TreMs / RAVEN / ATF blend): ${raven.classification}`);
    if (estAge) {
      if (raven.fcin && raven.fcin.ageLow && raven.fcin.ageHigh) {
        lines.push(`Approximate age (FCIN12-style): central ~${estAge} years; indicative range ~${raven.fcin.ageLow}–${raven.fcin.ageHigh} years.`);
      } else {
        lines.push(`Approximate age (FCIN12-style): ~${estAge} years`);
      }
    }
    lines.push("");

    lines.push("TreMs / veteran features");
    lines.push(`- Microhabitats (TreMs) recorded: ${featureSummary.totalCount} (primary ${featureSummary.primaryCount}, secondary ${featureSummary.secondaryCount})`);
    lines.push(`- Primary score: ${featureSummary.primaryScore}, secondary score: ${featureSummary.secondaryScore}`);
    if (featureSummary.rareCount > 0) lines.push(`- Rare TreMs (rarity 3): ${featureSummary.rareCount}`);
    if (featureSummary.uniqueFeatureNames.length) {
      lines.push("- Feature themes: " + featureSummary.uniqueFeatureNames.join("; "));
    }
    lines.push("");

    if (targetZoneVal) lines.push(`Target use (fall zone): ${targetZoneVal}`);
    if (ctxText) lines.push(`Context: ${ctxText}`);
    if (notesText) lines.push(`Inspector notes: ${notesText}`);
    lines.push("");

    if (currentPhotoNames.length) {
      lines.push("Photos (filenames on device):");
      currentPhotoNames.forEach((name, idx) => {
        lines.push(`  ${idx + 1}. ${name}`);
      });
      lines.push("");
    }

    lines.push("Reasoning (summary)");
    raven.reasons.forEach((r, i) => {
      lines.push(`- ${r}`);
    });

    return lines.join("\n");
  }

  function buildPdfReport(params) {
    const {
      speciesLabel,
      dbhMm,
      measHeight,
      girthVal,
      heightVal,
      growthCond,
      estAge,
      raven,
      featureSummary,
      ctxText,
      notesText,
      targetZoneVal
    } = params;

    const parts = [];
    parts.push('<div id="pdfReport-header">');
    if (logoDataUrl) {
      parts.push(`<div><img id="pdfReport-logo" src="${logoDataUrl}" alt="Logo" /></div>`);
    } else {
      parts.push('<div></div>');
    }
    parts.push('<div style="text-align:right;font-size:11px;"><div><strong>Ancient &amp; Veteran Tree Tool</strong></div><div>Field assessment</div></div>');
    parts.push('</div>');

    parts.push('<h1>Tree assessment</h1>');

    parts.push('<h2>Summary</h2>');
    parts.push(`<p><strong>Species:</strong> ${speciesLabel}</p>`);
    if (dbhMm) parts.push(`<p><strong>DBH:</strong> ${dbhMm.toFixed(0)} mm @ ${measHeight.toFixed(2)} m</p>`);
    parts.push(`<p><strong>Girth:</strong> ${girthVal.toFixed(2)} m @ ${measHeight.toFixed(2)} m</p>`);
    if (heightVal) parts.push(`<p><strong>Approx. height:</strong> ${heightVal.toFixed(1)} m</p>`);
    parts.push(`<p><strong>Growth conditions (FCIN12):</strong> ${growthCond}</p>`);
    parts.push(`<p><strong>ATF size band:</strong> ${raven.atfBand}</p>`);
    parts.push(`<p><strong>Overall category:</strong> ${raven.classification}</p>`);
    if (estAge) parts.push(`<p><strong>Approx. age (FCIN12-style):</strong> ~${estAge} years</p>`);

    parts.push('<h2>TreMs / veteran features</h2>');
    parts.push('<ul>');
    parts.push(`<li>Microhabitats (TreMs) recorded: ${featureSummary.totalCount} (primary ${featureSummary.primaryCount}, secondary ${featureSummary.secondaryCount})</li>`);
    parts.push(`<li>Primary score: ${featureSummary.primaryScore}, secondary score: ${featureSummary.secondaryScore}</li>`);
    if (featureSummary.rareCount > 0) parts.push(`<li>Rare TreMs (rarity 3): ${featureSummary.rareCount}</li>`);
    if (featureSummary.uniqueFeatureNames.length) {
      parts.push(`<li>Feature themes: ${featureSummary.uniqueFeatureNames.join("; ")}</li>`);
    }
    parts.push('</ul>');

    parts.push('<h2>Context &amp; notes</h2>');
    parts.push('<ul>');
    if (targetZoneVal) parts.push(`<li>Target use (fall zone): ${targetZoneVal}</li>`);
    if (ctxText) parts.push(`<li>Context: ${ctxText}</li>`);
    if (notesText) parts.push(`<li>Inspector notes: ${notesText}</li>`);
    parts.push('</ul>');

    if (currentPhotoData.length) {
      parts.push('<h2>Photos</h2>');
      currentPhotoData.forEach((p, idx) => {
        parts.push(`<div><div><strong>Photo ${idx + 1} – ${p.name}</strong></div><img class="photo" src="${p.dataUrl}" alt="${p.name}" /></div>`);
      });
    }

    parts.push('<h2>Reasoning</h2>');
    if (raven.reasons && raven.reasons.length) {
      parts.push('<ul>');
      raven.reasons.forEach(r => {
        parts.push(`<li>${r}</li>`);
      });
      parts.push('</ul>');
    }

    pdfReport.innerHTML = parts.join('');
  }

  
  function buildPngSnapshot(params) {
    const { speciesLabel, dbhMm, measHeight, girthVal, heightVal, growthCond, estAge, raven, featureSummary, ctxText, notesText, targetZoneVal, multiStemEnabled, multiStemDiams, multiStemEqDbh } = params;

    const targetMap = {
      none: "Very low target use",
      occasional: "Occasional use",
      regular: "Regular use",
      constant: "Constant high use"
    };
    const targetLabel = targetMap[targetZoneVal] || "";

    let html = "";
    html += '<div class="card" style="max-width:900px;margin:0 auto;background:#020617;color:#e5e7eb;border-radius:1rem;padding:0.9rem 1.1rem;">';
    html += '<div class="result-block" style="margin-top:0;">';
    html += '<h3 style="margin:0 0 0.35rem 0;font-size:0.95rem;">Field snapshot</h3>';

    html += '<div class="statusbar" style="margin-bottom:0.4rem;">';
    html += `<span class="pill pill-info">${speciesLabel}</span>`;
    html += `<span class="pill pill-info">ATF: ${raven.atfBand}</span>`;
    if (estAge) {
      html += `<span class="pill pill-ok">~${estAge} yrs (FCIN12)</span>`;
    }
    html += `<span class="pill pill-warn">${featureSummary.totalCount} TreMs</span>`;
    if (featureSummary.rareCount > 0) {
      html += `<span class="pill pill-ok">${featureSummary.rareCount} rare TreMs</span>`;
    }
    if (targetLabel) {
      html += `<span class="pill pill-alert">${targetLabel}</span>`;
    }
    html += '</div>';

    html += '<div class="result-grid" style="font-size:0.8rem;margin-top:0.3rem;">';
    html += '<div><div class="result-label">DBH</div>';
    html += `<div>${dbhMm ? dbhMm.toFixed(0) + " mm @ " + measHeight.toFixed(2) + " m" : "—"}</div></div>`;
    if (multiStemEnabled && multiStemDiams && multiStemDiams.length) {
      const stemList = multiStemDiams.map(d => Math.round(d)).join(", ");
      const eqTxt = multiStemEqDbh ? ` → eq. ${Math.round(multiStemEqDbh)} mm` : "";
      html += '<div><div class="result-label">Stems</div>';
      html += `<div>${stemList} mm${eqTxt}</div></div>`;
    }

    html += '<div><div class="result-label">Girth</div>';
    html += `<div>${girthVal.toFixed(2)} m @ ${measHeight.toFixed(2)} m</div></div>`;
    html += '<div><div class="result-label">Height</div>';
    html += `<div>${heightVal ? heightVal.toFixed(1) + " m" : "—"}</div></div>`;
    html += '<div><div class="result-label">Overall category (blended)</div>';
    html += `<div><strong>${raven.classification}</strong></div></div>`;
    if (raven && raven.raven2 && raven.raven2.classification) {
      html += '<div><div class="result-label">RAVEN2 outcome</div>';
      html += `<div>${raven.raven2.classification}</div></div>`;
    }
    html += '</div>';

    if (ctxText || notesText || (surveyorNameInput && surveyorNameInput.value.trim())) {
      html += '<div class="divider" style="margin:0.6rem 0;"></div>';
      html += '<div class="result-label">Context & notes</div>';
      html += '<ul style="margin:0.2rem 0 0 1.1rem;font-size:0.8rem;">';
      if (surveyorNameInput && surveyorNameInput.value.trim()) html += `<li><strong>Surveyor:</strong> ${surveyorNameInput.value.trim()}</li>`;
      if (ctxText) html += `<li><strong>Context:</strong> ${ctxText}</li>`;
      if (notesText) html += `<li><strong>Inspector notes:</strong> ${notesText}</li>`;
      html += '</ul>';
    }

    if (currentPhotoData && currentPhotoData.length) {
      html += '<div class="divider" style="margin:0.6rem 0;"></div>';
      html += '<div class="result-label">Photos</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:0.35rem;margin-top:0.25rem;">';
      currentPhotoData.forEach(p => {
        html += `<div style="flex:0 0 auto;"><img src="${p.dataUrl}" alt="${p.name}" style="width:120px;height:120px;object-fit:cover;border-radius:0.5rem;border:1px solid rgba(148,163,184,0.7);" /></div>`;
      });
      html += '</div>';
    }

    html += '</div>';
    html += '</div>';

    pngSnapshot.innerHTML = html;
  }

btnAssess.addEventListener("click", () => {
    const speciesKey = speciesSelect.value || "default";
    const speciesCfg = SPECIES_CONFIG[speciesKey] || SPECIES_CONFIG.default;
    const speciesLabel = speciesCustom.value.trim() || speciesCfg.label;

    const dbhMm = parseFloat(dbhInput.value);
    const measHeight = parseFloat(dbhHeightInput.value) || 1.3;

    let girthVal = parseFloat(girthInput.value);
    if (dbhMm && dbhMm > 0) {
      const dbhMeters = dbhMm / 1000.0;
      const computedGirth = Math.PI * dbhMeters;
      girthVal = computedGirth;
      girthInput.value = computedGirth.toFixed(2);
    }

    const heightVal = parseFloat(heightInput.value) || null;
    const growthCond = growthCondSelect.value || "average";

    if (!girthVal || girthVal <= 0) {
      alert("Please enter either a positive DBH (mm) or girth (m).");
      return;
    }

    const featureSummary = summariseFeatures();
    const estAge = estimateAgeFromFCIN12(girthVal, speciesKey, growthCond);
    const fcin = evaluateFCIN12(estAge, speciesKey, girthVal, growthCond);
    const ravenFeatures = summariseRavenFeatures();
    const raven2 = evaluateRaven2(estAge, ravenFeatures, fcin);
    const raven = classifyRAVEN(estAge, speciesKey, girthVal, featureSummary, measHeight);
    const targetInfo = targetBadge(targetZone.value);

    // attach FCIN12 and RAVEN2 diagnostic info and prepend their reasoning
    if (fcin) {
      raven.fcin = fcin;
    }
    if (raven2) {
      raven.raven2 = raven2;
      raven.raven2Features = ravenFeatures;
    }

    raven.reasons = [];
    if (fcin && fcin.reasons && fcin.reasons.length) {
      raven.reasons = raven.reasons.concat(fcin.reasons);
    }
    if (raven2 && raven2.reasons && raven2.reasons.length) {
      raven.reasons = raven.reasons.concat(raven2.reasons);
    }

    const lines = [];

    lines.push('<div class="result-block">');
    lines.push('<h3>Headline</h3>');
    lines.push('<div class="statusbar">');

    lines.push(`<span class="pill pill-info">${speciesLabel}</span>`);
    lines.push(`<span class="pill pill-info">ATF band: ${raven.atfBand}</span>`);
    if (estAge) {
      lines.push(`<span class="pill pill-ok">Age ~${estAge} years (FCIN12)</span>`);
    } else {
      lines.push(`<span class="pill pill-info">Age not estimated</span>`);
    }
    lines.push(`<span class="pill pill-warn">${featureSummary.totalCount} TreMs</span>`);
    if (featureSummary.rareCount > 0) {
      lines.push(`<span class="pill pill-ok">${featureSummary.rareCount} rare TreMs</span>`);
    }
    const combinedIsAncient = raven.classification.startsWith("Ancient");
    if (raven.inAncientBand !== combinedIsAncient) {
      lines.push(`<span class="pill pill-alert">ATF vs overall differ</span>`);
    }
    if (targetInfo) {
      lines.push(`<span class="pill ${targetInfo.cls}">${targetInfo.text}</span>`);
    }
    lines.push('</div>');

    lines.push('<div class="result-grid">');
    lines.push('<div><div class="result-label">DBH</div>');
    lines.push(`<div>${dbhMm ? dbhMm.toFixed(0) + " mm @ " + measHeight.toFixed(2) + " m" : "—"}</div></div>`);
    lines.push('<div><div class="result-label">Girth</div>');
    lines.push(`<div>${girthVal.toFixed(2)} m @ ${measHeight.toFixed(2)} m</div></div>`);
    lines.push('<div><div class="result-label">Height</div>');
    lines.push(`<div>${heightVal ? heightVal.toFixed(1) + " m" : "—"}</div></div>`);
    lines.push('<div><div class="result-label">Growth</div>');
    lines.push(`<div>${growthCond[0].toUpperCase() + growthCond.slice(1)} </div></div>`);
    lines.push('<div><div class="result-label">Overall category (blended)</div>');
    lines.push(`<div><strong>${raven.classification}</strong></div></div>`);
    if (raven.raven2 && raven.raven2.classification) {
      lines.push('<div><div class="result-label">RAVEN2 outcome</div>');
      lines.push(`<div>${raven.raven2.classification}</div></div>`);
    }
    lines.push('</div>');

    if (raven.reasons && raven.reasons.length) {
      lines.push('<div class="divider"></div>');
      lines.push('<div class="result-label">Reasoning (FCIN12 / RAVEN2 / ATF / TreMs)</div>');
      lines.push('<ul style="margin:0.3rem 0 0 1.1rem;font-size:0.8rem;">');
      raven.reasons.forEach(r => lines.push(`<li>${r}</li>`));
      lines.push('</ul>');
    }

    const ctxText = siteContext.value.trim();
    const notesText = notes.value.trim();
    if (ctxText || notesText) {
      lines.push('<div class="divider"></div>');
      lines.push('<div class="result-label">Site &amp; notes</div>');
      lines.push('<ul style="margin:0.25rem 0 0 1.1rem;font-size:0.8rem;">');
      if (ctxText) lines.push(`<li><strong>Context:</strong> ${ctxText}</li>`);
      if (notesText) lines.push(`<li><strong>Inspector notes:</strong> ${notesText}</li>`);
      lines.push('</ul>');
    }

    lines.push('</div>');
    resultsDiv.innerHTML = lines.join("");



    const multiStemEnabled = !!(multiStemToggle && multiStemToggle.checked);
    const multiStemDiams = multiStemEnabled ? getStemDiams().map(v => Number(v)).filter(v => Number.isFinite(v) && v > 0) : [];
    const multiStemEqDbh = multiStemEnabled ? bs5837EquivalentDbh(multiStemDiams) : null;
    const report = buildReportText({
      speciesLabel,
      dbhMm,
      measHeight,
      girthVal,
      heightVal,
      growthCond,
      estAge,
      raven,
      featureSummary,
      ctxText,
      notesText,
      targetZoneVal: targetZone.value,
      multiStemEnabled,
      multiStemDiams,
      multiStemEqDbh
    });
    reportTextArea.value = report;

    // build hidden PDF report
    buildPdfReport({
      speciesLabel,
      dbhMm,
      measHeight,
      girthVal,
      heightVal,
      growthCond,
      estAge,
      raven,
      featureSummary,
      ctxText,
      notesText,
      targetZoneVal: targetZone.value,
      multiStemEnabled,
      multiStemDiams,
      multiStemEqDbh
    });
  
    // build hidden PNG snapshot card

    buildPngSnapshot({
      speciesLabel,
      dbhMm,
      measHeight,
      girthVal,
      heightVal,
      growthCond,
      estAge,
      raven,
      featureSummary,
      ctxText,
      notesText,
      targetZoneVal: targetZone.value,
      multiStemEnabled,
      multiStemDiams,
      multiStemEqDbh
    });
});

  btnClear.addEventListener("click", () => {
    speciesSelect.value = "";
    speciesCustom.value = "";
    dbhInput.value = "";
    dbhHeightInput.value = "1.3";
    girthInput.value = "";
    heightInput.value = "";
    growthCondSelect.value = "average";
    siteContext.value = "";
    targetZone.value = "none";
    notes.value = "";
    if (surveyorNameInput) surveyorNameInput.value = "";
    logoInput.value = "";
    logoDataUrl = null;
    appHeaderLogo.src = "";
    appHeaderLogo.style.display = "none";
    photoInput.value = "";
    currentPhotoNames = [];
    currentPhotoData = [];
    photoListDiv.innerHTML = "";
    document.querySelectorAll(".microhabitat").forEach(inp => { if ("checked" in inp) inp.checked = false; inp.value = "0"; });
    document.querySelectorAll(".raven-feature").forEach(inp => inp.checked = false);
    document.querySelectorAll(".fcin-flag").forEach(inp => inp.checked = false);
    resultsDiv.innerHTML = "";
    reportTextArea.value = "";
    pdfReport.innerHTML = "";
  });

  btnCopyReport.addEventListener("click", () => {
    const txt = reportTextArea.value;
    if (!txt) {
      alert("Run an assessment first so there is some report text to copy.");
      return;
    }
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).then(() => {
        alert("Report text copied to clipboard.");
      }).catch(() => {
        reportTextArea.removeAttribute("readonly");
        reportTextArea.focus();
        reportTextArea.select();
        try {
          const ok = document.execCommand("copy");
          if (ok) {
            alert("Report text copied to clipboard.");
          } else {
            alert("Could not access clipboard. Text selected – please copy manually.");
          }
        } catch (e) {
          alert("Could not access clipboard. Text selected – please copy manually.");
        }
        reportTextArea.setAttribute("readonly", "readonly");
      });
    } else {
      reportTextArea.removeAttribute("readonly");
      reportTextArea.focus();
      reportTextArea.select();
      try {
        const ok = document.execCommand("copy");
        if (ok) {
          alert("Report text copied to clipboard.");
        } else {
          alert("Clipboard not available. Text selected – please copy manually.");
        }
      } catch (e) {
        alert("Clipboard not available. Text selected – please copy manually.");
      }
      reportTextArea.setAttribute("readonly", "readonly");
    }
  });

  btnDownloadPng.addEventListener("click", async () => {
    if (!pngSnapshot.innerHTML.trim()) {
      alert("Run an assessment first so there is something to export.");
      return;
    }
    if (!window.html2canvas) {
      alert("Image library not loaded. Please check your connection and try again.");
      return;
    }
    try {
      const canvas = await html2canvas(pngSnapshot, { scale: 2 });
      const dataUrl = canvas.toDataURL("image/png");
      const link = document.createElement("a");
      const now = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      const defaultName =
        `tree-snapshot_${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}_` +
        `${pad(now.getHours())}${pad(now.getMinutes())}.png`;
      link.href = dataUrl;
      link.download = defaultName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (e) {
      console.error(e);
      alert("Something went wrong creating the image snapshot.");
    }
  });





  
  // TreMs grouped controls
  (function(){
    const btnEx = document.getElementById('btnTremsExpand');
    const btnCo = document.getElementById('btnTremsCollapse');
    const groups = () => Array.from(document.querySelectorAll('.trem-group'));
    if (btnEx) btnEx.addEventListener('click', () => groups().forEach(d => d.open = true));
    if (btnCo) btnCo.addEventListener('click', () => groups().forEach(d => d.open = false));
  })();
</script>
</body>
</html>
